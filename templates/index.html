<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trading Bot Ultimate</title>
<script src="https://unpkg.com/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>
<style>
/* ── Variables ───────────────────────────────────────────────────── */
:root {
  --bg:        #0b0e17;
  --bg2:       #111520;
  --panel:     #161b27;
  --panel2:    #1c2236;
  --border:    #252d3d;
  --border2:   #2f3a50;
  --text:      #cdd5e0;
  --muted:     #6b7a94;
  --accent:    #4f8ef7;
  --accent2:   #3a7bd5;
  --long:      #2dbb7a;
  --long-bg:   #0f2e1f;
  --short:     #e85555;
  --short-bg:  #2e0f0f;
  --warn:      #f0a832;
  --radius:    10px;
  --radius-sm: 6px;
}

/* ── Reset ───────────────────────────────────────────────────────── */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html { scroll-behavior: smooth; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', sans-serif;
  font-size: 13px;
  line-height: 1.5;
  min-height: 100vh;
}

/* ── Scrollbar ───────────────────────────────────────────────────── */
::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 4px; }

/* ── Header ──────────────────────────────────────────────────────── */
.topbar {
  background: var(--bg2);
  border-bottom: 1px solid var(--border);
  padding: 0 20px;
  height: 52px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 100;
  backdrop-filter: blur(8px);
}

.topbar-left {
  display: flex;
  align-items: center;
  gap: 14px;
}

.brand {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 700;
  font-size: 15px;
  letter-spacing: -.3px;
  color: #fff;
}
.brand-dot {
  width: 8px;
  height: 8px;
  background: var(--long);
  border-radius: 50%;
  animation: pulse 2s infinite;
}
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50%       { opacity: .35; }
}
.brand span { color: var(--accent); }

.topbar-stats {
  display: flex;
  gap: 0;
  border-left: 1px solid var(--border);
  padding-left: 14px;
  margin-left: 4px;
}
.stat {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 0 12px;
  border-right: 1px solid var(--border);
  font-size: 11px;
}
.stat:last-child { border-right: none; }
.stat-label { color: var(--muted); }
.stat-val   { font-weight: 600; color: #fff; }
.stat-val.green { color: var(--long); }
.stat-val.red   { color: var(--short); }
.stat-val.blue  { color: var(--accent); }

.badge-status {
  font-size: 11px;
  padding: 3px 10px;
  border-radius: 20px;
  background: var(--panel);
  color: var(--muted);
  font-weight: 500;
  display: none;
}
.badge-status.running { background: #1b2d50; color: var(--accent); display: inline; }
.badge-status.done    { background: var(--long-bg); color: var(--long); display: inline; }
.badge-status.error   { background: var(--short-bg); color: var(--short); display: inline; }

/* ── Controls bar ────────────────────────────────────────────────── */
.ctrlbar {
  background: var(--bg2);
  border-bottom: 1px solid var(--border);
  padding: 10px 20px;
  display: flex;
  align-items: center;
  gap: 16px;
  flex-wrap: wrap;
}

.ctrl-group {
  display: flex;
  align-items: center;
  gap: 8px;
}

.ctrl-label {
  color: var(--muted);
  font-size: 11px;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: .5px;
  white-space: nowrap;
}

select {
  background: var(--panel);
  color: var(--text);
  border: 1px solid var(--border2);
  border-radius: var(--radius-sm);
  padding: 6px 10px;
  font-size: 12px;
  font-family: inherit;
  cursor: pointer;
  min-width: 160px;
  outline: none;
  transition: border-color .15s;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%236b7a94' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 8px center;
  padding-right: 28px;
}
select:focus { border-color: var(--accent); }

.tf-group { display: flex; gap: 6px; flex-wrap: wrap; }
.tf-lbl {
  display: flex;
  align-items: center;
  gap: 4px;
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 5px 11px;
  cursor: pointer;
  font-size: 11px;
  font-weight: 600;
  letter-spacing: .3px;
  user-select: none;
  color: var(--muted);
  transition: all .15s;
}
.tf-lbl input { display: none; }
.tf-lbl.on {
  border-color: var(--accent);
  background: #1b2d50;
  color: var(--accent);
}
.tf-lbl:hover { border-color: var(--border2); }

#scan-btn {
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  color: #fff;
  border: none;
  border-radius: var(--radius-sm);
  padding: 7px 22px;
  font-size: 13px;
  font-family: inherit;
  font-weight: 600;
  cursor: pointer;
  transition: opacity .15s, transform .1s;
  white-space: nowrap;
  box-shadow: 0 2px 8px rgba(79,142,247,.25);
}
#scan-btn:hover:not(:disabled)  { opacity: .88; transform: translateY(-1px); }
#scan-btn:active:not(:disabled) { transform: translateY(0); }
#scan-btn:disabled { background: var(--panel2); color: var(--muted); cursor: not-allowed; box-shadow: none; }
#scan-btn.running {
  background: linear-gradient(135deg, #a07200, #f0a832);
  animation: btnPulse 1.5s infinite;
}
@keyframes btnPulse {
  0%, 100% { box-shadow: 0 2px 8px rgba(240,168,50,.25); }
  50%       { box-shadow: 0 2px 18px rgba(240,168,50,.5); }
}

/* ── Body layout ─────────────────────────────────────────────────── */
.body-wrap {
  display: grid;
  grid-template-columns: 1fr 280px;
  grid-template-rows: auto 1fr;
  gap: 0;
  height: calc(100vh - 52px - 53px);
  min-height: 0;
}

.main-col {
  overflow-y: auto;
  padding: 16px 20px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.side-col {
  border-left: 1px solid var(--border);
  background: var(--bg2);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* ── Logs ────────────────────────────────────────────────────────── */
.logs-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 14px;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  user-select: none;
}
.logs-title {
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: .8px;
  color: var(--muted);
  display: flex;
  align-items: center;
  gap: 6px;
}
.logs-chevron { color: var(--muted); font-size: 10px; transition: transform .2s; }
.logs-chevron.open { transform: rotate(180deg); }

.clr-btn {
  background: none;
  border: 1px solid var(--border);
  color: var(--muted);
  padding: 2px 8px;
  font-size: 10px;
  border-radius: 4px;
  cursor: pointer;
  font-family: inherit;
  transition: all .15s;
}
.clr-btn:hover { border-color: var(--accent); color: var(--accent); }

#logs {
  flex: 1;
  overflow-y: auto;
  padding: 10px 14px;
  font-family: 'Consolas', 'Menlo', monospace;
  font-size: 10.5px;
  line-height: 1.7;
  background: var(--bg);
}
.li  { color: var(--muted); }
.lw  { color: var(--warn); }
.le  { color: var(--short); }
.ls  { color: var(--long); font-weight: bold; }
.lx  { color: var(--accent); font-style: italic; }

/* ── Results ─────────────────────────────────────────────────────── */
.section-hdr {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}
.section-title {
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: .8px;
  color: var(--muted);
}
#cnt {
  background: var(--panel2);
  color: var(--accent);
  font-size: 10px;
  font-weight: 600;
  padding: 3px 10px;
  border-radius: 20px;
  border: 1px solid var(--border2);
}

/* ── Table ───────────────────────────────────────────────────────── */
.tbl-scroll { overflow-x: auto; border-radius: var(--radius); border: 1px solid var(--border); }

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 12px;
}
thead th {
  background: var(--panel);
  color: var(--muted);
  text-align: left;
  padding: 9px 12px;
  border-bottom: 1px solid var(--border);
  font-weight: 600;
  text-transform: uppercase;
  font-size: 10px;
  letter-spacing: .5px;
  white-space: nowrap;
}
tbody tr {
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  transition: background .1s;
}
tbody tr:last-child { border-bottom: none; }
tbody tr:hover { background: var(--panel); }
tbody tr.active-row { background: #1b2d50 !important; }
tbody td { padding: 9px 12px; vertical-align: middle; white-space: nowrap; }

/* Direction badge */
.dir-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 3px 9px;
  border-radius: 20px;
  font-size: 10px;
  font-weight: 700;
  letter-spacing: .3px;
}
.dir-long  { background: var(--long-bg); color: var(--long); border: 1px solid rgba(45,187,122,.25); }
.dir-short { background: var(--short-bg); color: var(--short); border: 1px solid rgba(232,85,85,.25); }
.dir-long::before  { content: "▲"; font-size: 8px; }
.dir-short::before { content: "▼"; font-size: 8px; }

/* Price cells */
.pe { color: var(--accent); font-weight: 600; font-variant-numeric: tabular-nums; }
.ps { color: var(--short); font-variant-numeric: tabular-nums; }
.pt1{ color: var(--warn); font-variant-numeric: tabular-nums; }
.pt2{ color: var(--long); font-weight: 600; font-variant-numeric: tabular-nums; }
.prr{ color: var(--muted); font-variant-numeric: tabular-nums; }

/* Pair + TF */
.pair-cell { font-weight: 700; color: #e0e8f5; }
.tf-badge {
  display: inline-block;
  background: var(--panel2);
  color: var(--muted);
  padding: 2px 7px;
  border-radius: 4px;
  font-size: 10px;
  font-weight: 600;
  border: 1px solid var(--border);
}
.tf-badge.sniper {
  background: #1f1b40;
  color: #9b89f5;
  border-color: rgba(155,137,245,.3);
}

/* Pattern cell */
.pattern-cell { color: #b0bec5; }
.fire { color: var(--warn); }

/* ADX */
.adx-ok  { color: var(--long); font-weight: 600; }
.adx-low { color: var(--muted); }

/* Pine button */
.pine-btn {
  background: var(--panel2);
  color: var(--accent);
  border: 1px solid var(--border2);
  padding: 3px 9px;
  font-size: 10px;
  font-weight: 500;
  border-radius: 4px;
  cursor: pointer;
  font-family: inherit;
  transition: all .15s;
}
.pine-btn:hover { background: #1b2d50; border-color: var(--accent); }
.pine-btn.ok { background: var(--long-bg); color: var(--long); border-color: var(--long); }

/* Score bar */
.score {
  display: inline-flex;
  align-items: center;
  gap: 3px;
  font-size: 11px;
  font-weight: 600;
}
.score-pip {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--border2);
}
.score-pip.on { background: var(--accent); }
.score-pip.on.hi { background: var(--long); }
.score-pip.on.lo { background: var(--warn); }

/* Empty state */
.empty {
  text-align: center;
  padding: 56px 24px;
  color: var(--muted);
}
.empty-icon { font-size: 32px; margin-bottom: 12px; opacity: .6; }
.empty-title { font-size: 14px; font-weight: 600; color: var(--text); margin-bottom: 6px; }
.empty-sub { font-size: 12px; color: var(--muted); }

/* ── Chart section ───────────────────────────────────────────────── */
#chart-section {
  display: none;
  border-top: 1px solid var(--border);
  background: var(--bg2);
}

.chart-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 16px;
  border-bottom: 1px solid var(--border);
}

.chart-meta {
  display: flex;
  align-items: center;
  gap: 12px;
}
.chart-pair { font-size: 14px; font-weight: 700; color: #fff; }
.chart-tf   { background: var(--panel2); color: var(--muted); padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
.chart-levels {
  display: flex;
  gap: 10px;
  font-size: 11px;
}
.chart-levels .el { color: var(--accent); }
.chart-levels .sl { color: var(--short); }
.chart-levels .tp { color: var(--long); }

.close-chart {
  background: none;
  border: 1px solid var(--border2);
  color: var(--muted);
  padding: 4px 12px;
  font-size: 11px;
  font-weight: 500;
  border-radius: var(--radius-sm);
  cursor: pointer;
  font-family: inherit;
  transition: all .15s;
}
.close-chart:hover { border-color: var(--short); color: var(--short); }

#chart-box {
  background: var(--bg);
  height: 460px;
}

/* ── Responsive ──────────────────────────────────────────────────── */
@media (max-width: 960px) {
  .body-wrap {
    grid-template-columns: 1fr;
    grid-template-rows: auto auto;
    height: auto;
    min-height: 0;
  }
  .side-col {
    border-left: none;
    border-top: 1px solid var(--border);
    height: 180px;
  }
  .topbar-stats { display: none; }
}

@media (max-width: 640px) {
  .ctrlbar { padding: 10px 12px; gap: 10px; }
  .main-col { padding: 12px; }
  thead th:nth-child(6),
  thead th:nth-child(7),
  thead th:nth-child(8),
  thead th:nth-child(10) { display: none; }
  tbody td:nth-child(6),
  tbody td:nth-child(7),
  tbody td:nth-child(8),
  tbody td:nth-child(10) { display: none; }
  #chart-box { height: 320px; }
}

/* ── HTF label ───────────────────────────────────────────────────── */
.htf-tag {
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 4px;
  background: #1f1b40;
  color: #9b89f5;
  border: 1px solid rgba(155,137,245,.25);
  white-space: nowrap;
}
.htf-tag.blocked { background: var(--short-bg); color: var(--short); border-color: rgba(232,85,85,.25); }
</style>
</head>
<body>

<!-- ── Top bar ────────────────────────────────────────────────────── -->
<header class="topbar">
  <div class="topbar-left">
    <div class="brand">
      <div class="brand-dot"></div>
      Trading<span>Bot</span> Ultimate
    </div>
    <div class="topbar-stats">
      <div class="stat">
        <span class="stat-label">Signaux</span>
        <span class="stat-val blue" id="stat-total">0</span>
      </div>
      <div class="stat">
        <span class="stat-label">LONG</span>
        <span class="stat-val green" id="stat-long">0</span>
      </div>
      <div class="stat">
        <span class="stat-label">SHORT</span>
        <span class="stat-val red" id="stat-short">0</span>
      </div>
      <div class="stat">
        <span class="stat-label">Top paire</span>
        <span class="stat-val" id="stat-top">—</span>
      </div>
    </div>
  </div>
  <span class="badge-status" id="badge"></span>
</header>

<!-- ── Controls bar ──────────────────────────────────────────────── -->
<div class="ctrlbar">
  <div class="ctrl-group">
    <span class="ctrl-label">Paire</span>
    <select id="pair-sel">
      <option value="">Toutes les paires</option>
      {% for pair in pairs %}
      <option value="{{ pair }}">{{ pair }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="ctrl-group">
    <span class="ctrl-label">TF</span>
    <div class="tf-group">
      {% for tf in timeframes %}
      <label class="tf-lbl on" id="tfl-{{ tf }}">
        <input type="checkbox" value="{{ tf }}" checked onchange="toggleTF(this)">
        {{ tf }}
      </label>
      {% endfor %}
    </div>
  </div>

  <button id="scan-btn" onclick="startScan()">&#x1F50D;&nbsp; Lancer le scan</button>
</div>

<!-- ── Body ──────────────────────────────────────────────────────── -->
<div class="body-wrap">

  <!-- Main content -->
  <div class="main-col">

    <!-- Chart section (hidden by default) -->
    <div id="chart-section">
      <div class="chart-header">
        <div class="chart-meta">
          <span class="chart-pair" id="chart-pair">—</span>
          <span class="chart-tf"   id="chart-tf">—</span>
          <div class="chart-levels" id="chart-levels"></div>
        </div>
        <button class="close-chart" onclick="closeChart()">&#x2715;&nbsp;Fermer</button>
      </div>
      <div id="chart-box"></div>
    </div>

    <!-- Signals table -->
    <div>
      <div class="section-hdr">
        <span class="section-title">Signaux detectes</span>
        <span id="cnt">0 signal</span>
      </div>
      <div class="tbl-scroll">
        <table>
          <thead>
            <tr>
              <th>Paire</th>
              <th>TF</th>
              <th>Pattern</th>
              <th>Direction</th>
              <th>Score</th>
              <th>Entree</th>
              <th>SL</th>
              <th>TP1</th>
              <th>TP2</th>
              <th>RR</th>
              <th>ADX</th>
              <th>Pine</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="12">
              <div class="empty">
                <div class="empty-icon">&#x1F50D;</div>
                <div class="empty-title">Aucun scan lance</div>
                <div class="empty-sub">Configure tes paires et timeframes, puis clique sur "Lancer le scan"</div>
              </div>
            </td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </div><!-- /main-col -->

  <!-- Sidebar — Logs -->
  <div class="side-col">
    <div class="logs-header" onclick="toggleLogs(this)">
      <div class="logs-title">
        <span>&#x1F4CB;</span> Logs en temps réel
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <button class="clr-btn" onclick="event.stopPropagation();clearLogs()">Effacer</button>
        <span class="logs-chevron open">&#9660;</span>
      </div>
    </div>
    <div id="logs"><span class="lx">En attente du scan...</span></div>
  </div>

</div><!-- /body-wrap -->

<script>
let scanId = null, es = null, scanning = false, activeRow = null;

/* ── Timeframe toggles ────────────────────────────────────────────── */
function toggleTF(cb) {
  cb.parentElement.classList.toggle("on", cb.checked);
}

function getTFs() {
  return [...document.querySelectorAll(".tf-group input:checked")].map(c => c.value);
}

/* ── Logs ─────────────────────────────────────────────────────────── */
function log(msg, cls) {
  const d = document.getElementById("logs");
  const s = document.createElement("span");
  s.className = cls || classify(msg);
  s.textContent = msg;
  d.appendChild(s);
  d.appendChild(document.createElement("br"));
  d.scrollTop = d.scrollHeight;
}

function classify(m) {
  if (m.includes("ERROR") || m.includes("Erreur")) return "le";
  if (m.includes("WARNING"))                         return "lw";
  if (m.includes("signal") || m.includes("✅") || m.includes("SIGNAL")) return "ls";
  if (m.startsWith("[Sys]"))                         return "lx";
  return "li";
}

function clearLogs() { document.getElementById("logs").innerHTML = ""; }

function toggleLogs(hdr) {
  const chevron = hdr.querySelector(".logs-chevron");
  const logs    = document.getElementById("logs");
  const open    = chevron.classList.toggle("open");
  logs.style.display = open ? "" : "none";
}

/* ── Badge / button state ─────────────────────────────────────────── */
function setBadge(state, txt) {
  const b = document.getElementById("badge");
  b.className = "badge-status " + state;
  b.textContent = txt;
}

function resetBtn() {
  scanning = false;
  const b = document.getElementById("scan-btn");
  b.disabled = false;
  b.innerHTML = "&#x1F50D;&nbsp; Lancer le scan";
  b.classList.remove("running");
}

/* ── Stats bar ────────────────────────────────────────────────────── */
function updateStats(sigs) {
  const total = sigs.length;
  const longs = sigs.filter(s => s.direction === "LONG").length;
  const shorts = total - longs;
  const pairCount = {};
  sigs.forEach(s => { pairCount[s.pair] = (pairCount[s.pair] || 0) + 1; });
  const top = Object.entries(pairCount).sort((a,b) => b[1]-a[1])[0];
  document.getElementById("stat-total").textContent = total;
  document.getElementById("stat-long").textContent  = longs;
  document.getElementById("stat-short").textContent = shorts;
  document.getElementById("stat-top").textContent   = top ? top[0] : "—";
  document.getElementById("cnt").textContent = total + " signal" + (total > 1 ? "s" : "");
}

/* ── Scan ─────────────────────────────────────────────────────────── */
async function startScan() {
  if (scanning) return;
  const pair = document.getElementById("pair-sel").value;
  const tfs  = getTFs();
  if (!tfs.length) { alert("Selectionne au moins un timeframe !"); return; }

  scanning = true;
  const btn = document.getElementById("scan-btn");
  btn.disabled = true;
  btn.innerHTML = "<span style='display:inline-block;animation:spin .8s linear infinite'>&#9696;</span>&nbsp;Scan en cours...";
  btn.classList.add("running");
  setBadge("running", "Scan en cours...");
  clearLogs();
  log("[Sys] Demarrage...", "lx");
  clearTable();

  try {
    const r = await fetch("/api/scan", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ pairs: pair ? [pair] : [], timeframes: tfs })
    });
    const d = await r.json();
    scanId = d.scan_id;
    log(`[Sys] Scan ID : ${scanId}`, "lx");
    openSSE(scanId);
  } catch(e) {
    log(`[Sys] Erreur reseau : ${e.message}`, "le");
    resetBtn();
  }
}

function openSSE(id) {
  if (es) { es.close(); es = null; }
  es = new EventSource(`/api/stream/${id}`);
  es.onmessage = function(ev) {
    const m = ev.data;
    if (m === "__SCAN_DONE__") {
      log("[Sys] Scan termine — chargement des signaux...", "lx");
      es.close(); es = null;
      fetchResults(id);
    } else if (m !== "__HEARTBEAT__") {
      log(m);
    }
  };
  es.onerror = function() {
    log("[Sys] Connexion perdue — recuperation des resultats...", "lw");
    if (es) { es.close(); es = null; }
    fetchResults(id);
  };
}

async function fetchResults(id) {
  try {
    const r = await fetch(`/api/results/${id}`);
    const d = await r.json();
    if (d.status === "error") {
      setBadge("error", "Erreur");
      log(`[Sys] Erreur : ${d.error}`, "le");
    } else {
      setBadge("done", `${d.count} signal(s)`);
      log(`[Sys] ${d.count} signal(s) detecte(s).`, "lx");
      renderTable(d.signals);
      updateStats(d.signals);
    }
  } catch(e) {
    log(`[Sys] Erreur chargement : ${e.message}`, "le");
    setBadge("error", "Erreur");
  } finally {
    resetBtn();
  }
}

/* ── Table ────────────────────────────────────────────────────────── */
function clearTable() {
  document.getElementById("tbody").innerHTML =
    `<tr><td colspan="12"><div class="empty">
      <div class="empty-icon">&#x23F3;</div>
      <div class="empty-title">Scan en cours...</div>
      <div class="empty-sub">Les signaux apparaitront ici a la fin du scan</div>
    </div></td></tr>`;
  document.getElementById("cnt").textContent = "0 signal";
  updateStats([]);
}

function scorePips(val, max) {
  let html = '<span class="score">';
  for (let i = 0; i < max; i++) {
    let cls = "score-pip";
    if (i < val) {
      cls += " on";
      cls += (val >= 6) ? " hi" : (val <= 3 ? " lo" : "");
    }
    html += `<span class="${cls}"></span>`;
  }
  html += `</span>`;
  return html;
}

function renderTable(sigs) {
  if (!sigs.length) {
    document.getElementById("tbody").innerHTML =
      `<tr><td colspan="12"><div class="empty">
        <div class="empty-icon">&#x1F6AB;</div>
        <div class="empty-title">Aucun signal</div>
        <div class="empty-sub">Aucun signal valide sur cette selection. Essaie d'autres paires ou timeframes.</div>
      </div></td></tr>`;
    return;
  }

  document.getElementById("tbody").innerHTML = sigs.map((s, idx) => {
    const dir = s.direction === "LONG"
      ? `<span class="dir-badge dir-long">LONG</span>`
      : `<span class="dir-badge dir-short">SHORT</span>`;

    const comp = s.compression ? `&nbsp;<span class="fire">&#x1F525;</span>` : "";

    /* TF badge — sniper for M15/M30 */
    const isSniper = (s.timeframe === "15m" || s.timeframe === "30m");
    const tfBadge  = `<span class="tf-badge${isSniper ? " sniper" : ""}">${s.timeframe}</span>`;

    /* Score: extract number from reason string "XX/8" */
    const scoreMatch = (s.confluence || "").match(/(\d+)\/(\d+)/);
    const scoreVal   = scoreMatch ? parseInt(scoreMatch[1]) : 0;
    const scoreMax   = scoreMatch ? parseInt(scoreMatch[2]) : 8;
    const scoreHtml  = scorePips(scoreVal, scoreMax);

    /* ADX */
    const adx = s.adx >= 20
      ? `<span class="adx-ok">${s.adx}</span>`
      : `<span class="adx-low">${s.adx}</span>`;

    /* Pine button */
    const pine = s.pine_file
      ? `<button class="pine-btn" onclick="event.stopPropagation();copyPine('${s.pine_file.split('/').pop()}',this)">Pine</button>`
      : "—";

    return `<tr data-idx="${idx}" onclick="selectRow(this, '${s.pair}','${s.timeframe}',${s.entry},${s.sl},${s.tp1},${s.tp2},'${s.pattern || ""}',${s.zone_high},${s.zone_low},'${s.direction}')">
      <td class="pair-cell">${s.pair}</td>
      <td>${tfBadge}</td>
      <td class="pattern-cell">${s.pattern || "—"}${comp}</td>
      <td>${dir}</td>
      <td>${scoreHtml}</td>
      <td class="pe">${s.entry}</td>
      <td class="ps">${s.sl}</td>
      <td class="pt1">${s.tp1}</td>
      <td class="pt2">${s.tp2}</td>
      <td class="prr">1:${s.rr_ratio}</td>
      <td>${adx}</td>
      <td>${pine}</td>
    </tr>`;
  }).join("");
}

/* ── Chart ────────────────────────────────────────────────────────── */
let chartInstance = null;

function selectRow(tr, pair, tf, entry, sl, tp1, tp2, pattern, zoneHigh, zoneLow, direction) {
  if (activeRow) activeRow.classList.remove("active-row");
  tr.classList.add("active-row");
  activeRow = tr;
  showChart(pair, tf, entry, sl, tp1, tp2, pattern, zoneHigh, zoneLow, direction);
}

function showChart(pair, tf, entry, sl, tp1, tp2, pattern, zoneHigh, zoneLow, direction) {
  const section = document.getElementById("chart-section");
  section.style.display = "block";

  /* update header meta */
  document.getElementById("chart-pair").textContent = pair;
  document.getElementById("chart-tf").textContent   = tf;
  document.getElementById("chart-levels").innerHTML =
    `<span class="el">E: ${entry}</span>
     <span class="sl">SL: ${sl}</span>
     <span class="tp">TP1: ${tp1}</span>
     <span class="tp">TP2: ${tp2}</span>`;

  section.scrollIntoView({ behavior: "smooth", block: "start" });

  if (chartInstance) { chartInstance.remove(); chartInstance = null; }

  const box = document.getElementById("chart-box");
  box.innerHTML = `<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--muted);font-size:13px;">Chargement du graphique...</div>`;

  fetch(`/api/chart?pair=${encodeURIComponent(pair)}&timeframe=${tf}`)
    .then(r => r.json())
    .then(d => {
      if (d.error) {
        box.innerHTML = `<div style="padding:24px;color:var(--short)">${d.error}</div>`;
        return;
      }

      box.innerHTML = "";
      chartInstance = LightweightCharts.createChart(box, {
        layout    : { background: { color: "#0b0e17" }, textColor: "#8b9bb4" },
        grid      : { vertLines: { color: "#1a1e2e" }, horzLines: { color: "#1a1e2e" } },
        crosshair : { mode: LightweightCharts.CrosshairMode.Normal },
        rightPriceScale: { borderColor: "#252d3d" },
        timeScale : { borderColor: "#252d3d", timeVisible: true },
        width     : box.clientWidth,
        height    : 460,
      });

      const series = chartInstance.addCandlestickSeries({
        upColor      : "#2dbb7a", downColor      : "#e85555",
        borderUpColor: "#2dbb7a", borderDownColor: "#e85555",
        wickUpColor  : "#2dbb7a", wickDownColor  : "#e85555",
      });
      series.setData(d.candles);

      /* ENTRY / SL / TP lines */
      series.createPriceLine({ price: entry, color: "#4f8ef7", lineWidth: 2, lineStyle: 0, title: "ENTRY" });
      series.createPriceLine({ price: sl,    color: "#e85555", lineWidth: 1, lineStyle: 2, title: "SL"    });
      series.createPriceLine({ price: tp1,   color: "#f0a832", lineWidth: 1, lineStyle: 2, title: "TP1"   });
      series.createPriceLine({ price: tp2,   color: "#2dbb7a", lineWidth: 1, lineStyle: 0, title: "TP2"   });

      /* Zone de la figure */
      if (zoneHigh > 0 && zoneLow > 0 && zoneHigh !== zoneLow) {
        const borderColor = direction === "LONG" ? "#2dbb7a" : "#e85555";
        const label = pattern || "Zone";
        series.createPriceLine({ price: zoneHigh, color: borderColor, lineWidth: 2, lineStyle: 3, title: `▲ ${label}` });
        series.createPriceLine({ price: zoneLow,  color: borderColor, lineWidth: 2, lineStyle: 3, title: "▼ Zone" });
      }

      chartInstance.timeScale().fitContent();

      /* Resize on window resize */
      const resizeObs = new ResizeObserver(() => {
        if (chartInstance) chartInstance.applyOptions({ width: box.clientWidth });
      });
      resizeObs.observe(box);
    })
    .catch(e => {
      box.innerHTML = `<div style="padding:24px;color:var(--short)">Erreur : ${e.message}</div>`;
    });
}

function closeChart() {
  document.getElementById("chart-section").style.display = "none";
  if (chartInstance) { chartInstance.remove(); chartInstance = null; }
  if (activeRow) { activeRow.classList.remove("active-row"); activeRow = null; }
}

/* ── Copy Pine ────────────────────────────────────────────────────── */
async function copyPine(name, btn) {
  try {
    const r = await fetch(`/pine/${name}`);
    if (!r.ok) { alert("Fichier Pine introuvable."); return; }
    await navigator.clipboard.writeText(await r.text());
    btn.textContent = "Copie !"; btn.classList.add("ok");
    setTimeout(() => { btn.textContent = "Pine"; btn.classList.remove("ok"); }, 2000);
  } catch(e) { alert("Erreur : " + e.message); }
}

/* ── CSS spin animation ───────────────────────────────────────────── */
const style = document.createElement("style");
style.textContent = "@keyframes spin { to { transform: rotate(360deg); } }";
document.head.appendChild(style);
</script>
</body>
</html>
