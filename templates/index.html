<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trading Bot Ultimate</title>
<style>
:root {
  --bg:      #0d0d0d;
  --bg2:     #141414;
  --panel:   #1a1a1a;
  --panel2:  #222;
  --border:  #2a2a2a;
  --border2: #333;
  --text:    #e0e0e0;
  --muted:   #666;
  --accent:  #4f8ef7;
  --accent2: #3570d4;
  --long:    #2dcc74;
  --long-bg: #0a1f12;
  --short:   #e84545;
  --short-bg:#200a0a;
  --warn:    #f5a623;
  --purple:  #9b7ef5;
  --r: 10px;
  --rs: 6px;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', sans-serif;
  font-size: 13px;
  line-height: 1.5;
  height: 100vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}
::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 4px; }

/* â”€â”€ TOPBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.topbar {
  background: var(--bg2);
  border-bottom: 1px solid var(--border);
  height: 48px;
  padding: 0 16px;
  display: flex;
  align-items: center;
  gap: 0;
  flex-shrink: 0;
  z-index: 10;
}
.brand {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
  font-weight: 700;
  color: #fff;
  white-space: nowrap;
  padding-right: 16px;
  border-right: 1px solid var(--border);
}
.brand-dot {
  width: 7px; height: 7px;
  border-radius: 50%;
  background: var(--long);
  box-shadow: 0 0 8px var(--long);
  animation: pulse 2s ease-in-out infinite;
  flex-shrink: 0;
}
@keyframes pulse {
  0%,100% { opacity:1; box-shadow:0 0 6px var(--long); }
  50%      { opacity:.4; box-shadow:0 0 2px var(--long); }
}
.brand em { color: var(--accent); font-style: normal; }
.tstats {
  display: flex;
  align-items: center;
  padding-left: 12px;
}
.tstat {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 0 12px;
  border-right: 1px solid var(--border);
}
.tstat:last-child { border-right: none; }
.tval { font-size: 14px; font-weight: 700; line-height: 1.1; color: #e0e8f5; }
.tval.g { color: var(--long); }
.tval.r { color: var(--short); }
.tval.b { color: var(--accent); }
.tval.o { color: var(--warn); }
.tlbl { font-size: 9px; color: var(--muted); text-transform: uppercase; letter-spacing: .5px; margin-top: 1px; }
.topbar-right { margin-left: auto; display: flex; align-items: center; gap: 10px; }
.refresh-badge {
  font-size: 10px;
  color: var(--muted);
  padding: 3px 8px;
  border-radius: 10px;
  border: 1px solid var(--border);
}
.refresh-badge.active { color: var(--accent); border-color: var(--accent); animation: pulse 1.5s infinite; }

/* â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tabs {
  background: var(--bg2);
  border-bottom: 1px solid var(--border);
  display: flex;
  padding: 0 16px;
  gap: 4px;
  flex-shrink: 0;
}
.tab-btn {
  padding: 8px 16px;
  border: none;
  background: none;
  color: var(--muted);
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all 0.15s;
  font-family: inherit;
  white-space: nowrap;
  margin-bottom: -1px;
}
.tab-btn:hover { color: var(--text); }
.tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }
.tab-count {
  display: inline-block;
  font-size: 10px;
  font-weight: 700;
  padding: 1px 5px;
  border-radius: 8px;
  background: var(--panel2);
  color: var(--muted);
  margin-left: 4px;
}
.tab-count.has { background: rgba(79,142,247,0.15); color: var(--accent); }

/* â”€â”€ PANELS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.panel { display: none; flex: 1; overflow: hidden; flex-direction: column; }
.panel.active { display: flex; }

/* â”€â”€ ANALYSES PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toolbar {
  background: var(--bg2);
  border-bottom: 1px solid var(--border);
  padding: 8px 16px;
  display: flex;
  align-items: center;
  gap: 10px;
  flex-shrink: 0;
  flex-wrap: wrap;
}
.filter-group { display: flex; gap: 4px; }
.fbtn {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 3px 10px;
  font-size: 11px;
  font-weight: 600;
  color: var(--muted);
  cursor: pointer;
  transition: all 0.15s;
  font-family: inherit;
}
.fbtn:hover { border-color: var(--border2); color: var(--text); }
.fbtn.active { border-color: var(--accent); color: var(--accent); background: rgba(79,142,247,0.1); }
.new-btn {
  margin-left: auto;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  color: #fff;
  border: none;
  border-radius: var(--rs);
  padding: 5px 14px;
  font-size: 11px;
  font-weight: 700;
  cursor: pointer;
  font-family: inherit;
  transition: opacity 0.15s;
}
.new-btn:hover { opacity: 0.85; }

#analyses-grid {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
  gap: 14px;
  align-content: start;
}

/* â”€â”€ ANALYSIS CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.acard {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: var(--r);
  overflow: hidden;
  transition: border-color 0.15s, transform 0.15s;
}
.acard:hover { border-color: var(--border2); transform: translateY(-1px); }
.acard.long  { border-left: 3px solid var(--long); }
.acard.short { border-left: 3px solid var(--short); }
.acard.wait  { border-left: 3px solid var(--muted); }

/* Verdict header */
.acard-top {
  padding: 12px 14px 10px;
  display: flex;
  align-items: flex-start;
  gap: 10px;
}
.verdict {
  font-size: 20px;
  font-weight: 900;
  letter-spacing: -0.5px;
  min-width: 62px;
  padding: 5px 10px;
  border-radius: 7px;
  text-align: center;
  line-height: 1.1;
  flex-shrink: 0;
}
.verdict.long  { background: var(--long-bg); color: var(--long); border: 1px solid rgba(45,204,116,.3); }
.verdict.short { background: var(--short-bg); color: var(--short); border: 1px solid rgba(232,69,69,.3); }
.verdict.wait  { background: rgba(80,80,80,.15); color: var(--muted); border: 1px solid var(--border); }
.vmeta { flex: 1; min-width: 0; }
.vpair { font-size: 15px; font-weight: 800; color: #fff; line-height: 1.1; }
.vtf   { font-size: 11px; color: var(--muted); margin-top: 2px; }
.vpatt { font-size: 11px; color: var(--accent); margin-top: 3px; font-weight: 600; }

/* Score bar */
.score-wrap { padding: 0 14px 10px; }
.score-hd {
  display: flex;
  justify-content: space-between;
  font-size: 10px;
  color: var(--muted);
  margin-bottom: 4px;
}
.score-hd span:last-child { font-weight: 700; font-size: 11px; }
.score-bar { height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; }
.score-fill { height: 100%; border-radius: 2px; transition: width 0.6s ease; }

/* Pattern canvas */
.patt-wrap {
  padding: 0 14px 10px;
  position: relative;
}
.patt-canvas {
  display: block;
  width: 100%;
  height: 80px;
  border-radius: 6px;
  background: #0d0d0d;
}
.patt-lbl {
  position: absolute;
  top: 5px;
  right: 18px;
  font-size: 9px;
  color: var(--muted);
  background: rgba(0,0,0,.7);
  padding: 2px 6px;
  border-radius: 4px;
  pointer-events: none;
}

/* Screenshot thumbnail */
.thumb {
  display: block;
  width: calc(100% - 28px);
  margin: 0 14px 10px;
  height: 120px;
  object-fit: cover;
  border-radius: 6px;
  border: 1px solid var(--border);
  cursor: pointer;
}
.thumb:hover { border-color: var(--accent); }

/* Price grid */
.price-grid {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr 1fr;
  gap: 6px;
  padding: 0 14px 10px;
}
.pbox {
  background: var(--panel2);
  border-radius: var(--rs);
  padding: 6px 8px;
  text-align: center;
}
.pbox .pl { font-size: 9px; color: var(--muted); text-transform: uppercase; letter-spacing: .4px; margin-bottom: 2px; }
.pbox .pv { font-size: 12px; font-weight: 700; font-variant-numeric: tabular-nums; }
.pbox.entry .pv { color: var(--accent); }
.pbox.sl    .pv { color: var(--short); }
.pbox.tp1   .pv { color: var(--warn); }
.pbox.tp2   .pv { color: var(--long); }

/* Gates */
.gates {
  padding: 0 14px 8px;
  display: flex;
  gap: 6px;
  align-items: center;
}
.gate {
  font-size: 10px;
  font-weight: 600;
  padding: 2px 8px;
  border-radius: 10px;
}
.gate.ok   { background: rgba(45,204,116,.12); color: var(--long); border: 1px solid rgba(45,204,116,.25); }
.gate.fail { background: rgba(232,69,69,.12); color: var(--short); border: 1px solid rgba(232,69,69,.25); }

/* Tags */
.tags {
  padding: 0 14px 10px;
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
}
.tag { font-size: 10px; padding: 2px 8px; border-radius: 10px; }
.tadx  { background: rgba(45,204,116,.1); color: #56d364; }
.tqqe  { background: rgba(243,179,65,.1); color: #f5a623; }
.thtf  { background: rgba(155,126,245,.1); color: var(--purple); }
.trr   { background: rgba(79,142,247,.1); color: var(--accent); }
.twarn { background: rgba(232,69,69,.1); color: var(--short); }
.tcomp { background: rgba(245,166,35,.1); color: var(--warn); }
.trsi  { background: rgba(155,126,245,.1); color: var(--purple); }

/* Summary */
.summary {
  padding: 0 14px 12px;
  font-size: 11px;
  color: #8a8a8a;
  line-height: 1.5;
  border-top: 1px solid var(--border);
  margin-top: 4px;
  padding-top: 10px;
}

/* Empty state */
.empty {
  grid-column: 1 / -1;
  text-align: center;
  padding: 80px 20px;
  color: var(--muted);
}
.empty .ico { font-size: 48px; opacity: .3; margin-bottom: 14px; }
.empty h3 { font-size: 16px; color: var(--text); margin-bottom: 8px; font-weight: 600; }
.empty p { font-size: 12px; line-height: 1.6; }
.empty code {
  display: inline-block;
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 2px 7px;
  font-family: 'Consolas', monospace;
  font-size: 11px;
  color: var(--accent);
  margin-top: 6px;
}

/* â”€â”€ SCAN PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.scan-inner {
  display: grid;
  grid-template-columns: 1fr 300px;
  height: 100%;
  overflow: hidden;
}
.scan-main {
  display: flex;
  flex-direction: column;
  padding: 14px;
  gap: 10px;
  overflow: hidden;
}
.scan-ctrl {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--r);
  padding: 12px 14px;
  display: flex;
  gap: 10px;
  align-items: center;
  flex-wrap: wrap;
  flex-shrink: 0;
}
select {
  background: var(--panel);
  color: var(--text);
  border: 1px solid var(--border2);
  border-radius: var(--rs);
  padding: 5px 28px 5px 10px;
  font-size: 12px;
  font-family: inherit;
  cursor: pointer;
  outline: none;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='%235c6e8a' stroke-width='2.5'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 8px center;
  min-width: 140px;
  transition: border-color .15s;
}
select:focus { border-color: var(--accent); }
.btn-primary {
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  color: #fff;
  border: none;
  border-radius: var(--rs);
  padding: 6px 18px;
  font-size: 12px;
  font-weight: 700;
  cursor: pointer;
  font-family: inherit;
  box-shadow: 0 2px 10px rgba(79,142,247,.3);
  transition: opacity .15s, transform .1s;
}
.btn-primary:hover:not(:disabled) { opacity: .85; transform: translateY(-1px); }
.btn-primary:disabled { background: var(--panel2); color: var(--muted); box-shadow: none; cursor: not-allowed; }
.scan-log {
  flex: 1;
  background: #090909;
  border: 1px solid var(--border);
  border-radius: var(--r);
  overflow-y: auto;
  padding: 10px;
  font-family: 'Consolas', 'JetBrains Mono', monospace;
  font-size: 11px;
  color: #6a7a8a;
}
.ll { padding: 1px 0; }
.ll.sig { color: var(--long); }
.ll.err { color: var(--short); }
.ll.warn { color: var(--warn); }
.scan-side {
  border-left: 1px solid var(--border);
  overflow-y: auto;
  padding: 14px;
}
.side-title {
  font-size: 10px;
  font-weight: 700;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: .5px;
  margin-bottom: 10px;
}
.sig-card {
  background: var(--panel2);
  border-radius: var(--rs);
  padding: 10px;
  margin-bottom: 8px;
}
.sig-card.long  { border-left: 2px solid var(--long); }
.sig-card.short { border-left: 2px solid var(--short); }
.sig-pair { font-weight: 700; font-size: 12px; color: #fff; }
.sig-dir-l { color: var(--long); font-size: 10px; font-weight: 700; }
.sig-dir-s { color: var(--short); font-size: 10px; font-weight: 700; }
.sig-info { font-size: 10px; color: var(--muted); margin: 3px 0; }
.sig-prices { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-top: 6px; }
.sp { font-size: 10px; }
.sp span { color: var(--muted); }

/* â”€â”€ UPLOAD MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,.8);
  z-index: 200;
  display: none;
  align-items: center;
  justify-content: center;
}
.overlay.open { display: flex; }
.modal {
  background: var(--panel);
  border: 1px solid var(--border2);
  border-radius: var(--r);
  padding: 24px;
  width: 460px;
  max-width: 95vw;
}
.modal-hd {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 18px;
}
.modal-hd h2 { font-size: 15px; font-weight: 700; }
.modal-close {
  background: none; border: none;
  color: var(--muted); font-size: 20px; cursor: pointer; line-height: 1;
}
.modal-close:hover { color: var(--text); }
.drop-zone {
  border: 2px dashed var(--border2);
  border-radius: var(--rs);
  padding: 28px;
  text-align: center;
  cursor: pointer;
  transition: all 0.15s;
  margin-bottom: 14px;
}
.drop-zone:hover, .drop-zone.over { border-color: var(--accent); background: rgba(79,142,247,.04); }
.drop-icon { font-size: 28px; color: var(--muted); margin-bottom: 8px; }
.drop-txt { font-size: 12px; color: var(--muted); }
.drop-preview { font-size: 11px; color: var(--accent); margin-top: 6px; display: none; }
.modal-fields {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-bottom: 14px;
}
.field label {
  display: block;
  font-size: 10px;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: .5px;
  margin-bottom: 4px;
}
input[type=text] {
  width: 100%;
  background: var(--panel2);
  color: var(--text);
  border: 1px solid var(--border2);
  border-radius: var(--rs);
  padding: 6px 10px;
  font-size: 12px;
  font-family: inherit;
  outline: none;
}
input[type=text]:focus { border-color: var(--accent); }
.modal-submit {
  width: 100%;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  color: #fff;
  border: none;
  border-radius: var(--rs);
  padding: 9px;
  font-size: 13px;
  font-weight: 700;
  cursor: pointer;
  font-family: inherit;
  transition: opacity .15s;
}
.modal-submit:hover { opacity: .9; }
.modal-submit:disabled { background: var(--panel2); color: var(--muted); cursor: not-allowed; }

/* â”€â”€ LIGHTBOX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.lightbox {
  position: fixed; inset: 0;
  background: rgba(0,0,0,.93);
  z-index: 300;
  display: none;
  align-items: center;
  justify-content: center;
}
.lightbox.open { display: flex; }
.lightbox img {
  max-width: 95vw;
  max-height: 92vh;
  border-radius: 6px;
  border: 1px solid var(--border2);
}
.lightbox-close {
  position: fixed;
  top: 16px; right: 20px;
  background: var(--panel);
  border: 1px solid var(--border2);
  border-radius: 50%;
  width: 34px; height: 34px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; color: var(--text); font-size: 18px; line-height: 1;
  z-index: 301;
}
</style>
</head>
<body>

<!-- â•â•â• TOP BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="topbar">
  <div class="brand">
    <div class="brand-dot"></div>
    Trading Bot <em>Ultimate</em>
  </div>
  <div class="tstats">
    <div class="tstat">
      <div class="tval b" id="st-total">0</div>
      <div class="tlbl">Analyses</div>
    </div>
    <div class="tstat">
      <div class="tval g" id="st-long">0</div>
      <div class="tlbl">Long</div>
    </div>
    <div class="tstat">
      <div class="tval r" id="st-short">0</div>
      <div class="tlbl">Short</div>
    </div>
    <div class="tstat">
      <div class="tval o" id="st-score">â€”</div>
      <div class="tlbl">Score moy.</div>
    </div>
  </div>
  <div class="topbar-right">
    <div class="refresh-badge" id="refresh-badge">PrÃªt</div>
  </div>
</div>

<!-- â•â•â• TABS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tabs">
  <button class="tab-btn active" data-tab="analyses">
    Analyses MT4 <span class="tab-count" id="tc-analyses">0</span>
  </button>
  <button class="tab-btn" data-tab="scan">
    Scan API
  </button>
</div>

<!-- â•â•â• PANEL â€” ANALYSES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="panel active" id="panel-analyses">
  <div class="toolbar">
    <div class="filter-group" id="fdir">
      <button class="fbtn active" data-dir="ALL">Toutes</button>
      <button class="fbtn" data-dir="LONG" style="color:var(--long);border-color:rgba(45,204,116,.3)">Long</button>
      <button class="fbtn" data-dir="SHORT" style="color:var(--short);border-color:rgba(232,69,69,.3)">Short</button>
    </div>
    <div style="width:1px;height:20px;background:var(--border)"></div>
    <div class="filter-group" id="ftf">
      <button class="fbtn active" data-tf="ALL">Tous TF</button>
      <button class="fbtn" data-tf="M30">M30</button>
      <button class="fbtn" data-tf="H1">H1</button>
      <button class="fbtn" data-tf="H4">H4</button>
      <button class="fbtn" data-tf="D1">D1</button>
    </div>
    <button class="new-btn" onclick="openModal()">+ Nouvelle analyse</button>
  </div>

  <div id="analyses-grid">
    <div class="empty">
      <div class="ico">ğŸ“Š</div>
      <h3>Aucune analyse sauvegardÃ©e</h3>
      <p>Lance une analyse depuis le terminal :<br>
        <code>python -m bot.analysis.save_analysis --pair GBPUSD --tf H1 ...</code>
      </p>
    </div>
  </div>
</div>

<!-- â•â•â• PANEL â€” SCAN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="panel" id="panel-scan">
  <div class="scan-inner">
    <div class="scan-main">
      <div class="scan-ctrl">
        <select id="scan-pair">
          <option value="">Toutes les paires</option>
          {% for p in pairs %}
          <option value="{{ p }}">{{ p }}</option>
          {% endfor %}
        </select>
        <select id="scan-tf">
          <option value="">Tous les TF</option>
          {% for tf in timeframes %}
          <option value="{{ tf }}">{{ tf }}</option>
          {% endfor %}
        </select>
        <button class="btn-primary" id="scan-btn" onclick="startScan()">Lancer le scan</button>
        <span id="scan-status" style="font-size:11px;color:var(--muted)"></span>
      </div>
      <div class="scan-log" id="scan-log">
        <div class="ll" style="color:var(--muted)">PrÃªt. SÃ©lectionne une paire et lance le scan.</div>
      </div>
    </div>
    <div class="scan-side">
      <div class="side-title">Signaux dÃ©tectÃ©s</div>
      <div id="scan-sigs">
        <div style="color:var(--muted);font-size:11px;text-align:center;padding:20px 0">Aucun signal</div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â• UPLOAD MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="overlay" id="modal">
  <div class="modal">
    <div class="modal-hd">
      <h2>Nouvelle analyse MT4</h2>
      <button class="modal-close" onclick="closeModal()">Ã—</button>
    </div>
    <div class="drop-zone" id="drop-zone" onclick="document.getElementById('file-inp').click()">
      <div class="drop-icon">ğŸ“·</div>
      <div class="drop-txt">Glisse un screenshot ici ou clique pour choisir</div>
      <div class="drop-preview" id="drop-preview"></div>
    </div>
    <input type="file" id="file-inp" accept="image/*" style="display:none" onchange="onFileSelect(this)">
    <div class="modal-fields">
      <div class="field">
        <label>Paire</label>
        <select id="up-pair">
          {% for p in pairs %}<option>{{ p }}</option>{% endfor %}
        </select>
      </div>
      <div class="field">
        <label>Timeframe</label>
        <select id="up-tf">
          <option>M30</option><option selected>H1</option><option>H4</option><option>D1</option>
        </select>
      </div>
      <div class="field">
        <label>Template</label>
        <select id="up-tmpl">
          <option>Momentum</option>
          <option>RSI</option>
          <option>EXTREM_MONEY OR 2</option>
          <option>Harmoniques</option>
        </select>
      </div>
      <div class="field">
        <label>Notes</label>
        <input type="text" id="up-notes" placeholder="Contexteâ€¦">
      </div>
    </div>
    <button class="modal-submit" id="up-btn" onclick="submitUpload()">Enregistrer le screenshot</button>
  </div>
</div>

<!-- â•â•â• LIGHTBOX â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="lightbox" id="lightbox" onclick="closeLightbox()">
  <button class="lightbox-close" onclick="closeLightbox()">Ã—</button>
  <img id="lb-img" src="" alt="chart">
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PATTERN DRAWING ENGINE â€” Canvas 2D
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const PC = {
  bg2:   '#111',
  green: '#2dcc74',
  red:   '#e84545',
  warn:  '#f5a623',
  blue:  '#4f8ef7',
  gray:  '#4a5568',
  srg:   'rgba(45,204,116,0.12)',
  srr:   'rgba(232,69,69,0.12)',
  muted: '#555',
};

function dc(ctx, cx, o, c, hi, lo, col) {
  // draw candle at cx with open/close/high/low (SVG coords: y increases downward)
  ctx.strokeStyle = col; ctx.fillStyle = col; ctx.lineWidth = 1.5;
  ctx.beginPath(); ctx.moveTo(cx, hi); ctx.lineTo(cx, lo); ctx.stroke();
  const by = Math.min(o, c), bh = Math.max(2, Math.abs(c - o));
  ctx.fillRect(cx - 6, by, 12, bh);
}

function dsr(ctx, y, w, lbl, col, above) {
  ctx.strokeStyle = col; ctx.lineWidth = 1; ctx.setLineDash([4, 3]);
  ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(w, y); ctx.stroke();
  ctx.setLineDash([]); ctx.fillStyle = col; ctx.font = '8px sans-serif';
  ctx.fillText(lbl, 4, above ? y - 3 : y + 9);
}

function darr(ctx, x, y, dir) {
  ctx.fillStyle = dir === 'LONG' ? PC.green : PC.red;
  ctx.font = 'bold 18px sans-serif'; ctx.textAlign = 'left';
  ctx.fillText(dir === 'LONG' ? 'â†‘' : 'â†“', x, y);
}

function dline(ctx, pts, col, w2) {
  ctx.strokeStyle = col; ctx.lineWidth = w2 || 1.5; ctx.setLineDash([]);
  ctx.beginPath(); ctx.moveTo(pts[0][0], pts[0][1]);
  for (let i = 1; i < pts.length; i++) ctx.lineTo(pts[i][0], pts[i][1]);
  ctx.stroke();
}

function drawPattern(canvas, name, direction) {
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const w = canvas.width, h = canvas.height;
  ctx.clearRect(0, 0, w, h);
  ctx.fillStyle = PC.bg2; ctx.fillRect(0, 0, w, h);
  ctx.textAlign = 'left';

  const n = (name || '').toLowerCase();
  const L = direction === 'LONG';
  const MC = L ? PC.green : PC.red;

  if      (n.includes('pin bar') || n.includes('pin_bar'))       pPinBar(ctx, w, h, L);
  else if (n.includes('hammer') && !n.includes('shooting'))      pHammer(ctx, w, h);
  else if (n.includes('shooting star') || n.includes('shooting_star')) pShootingStar(ctx, w, h);
  else if (n.includes('engulf'))                                  pEngulfing(ctx, w, h, L);
  else if (n.includes('doji'))                                    pDoji(ctx, w, h, L);
  else if (n.includes('morning star'))                            pMorningStar(ctx, w, h);
  else if (n.includes('evening star'))                            pEveningStar(ctx, w, h);
  else if (n.includes('harami'))                                  pHarami(ctx, w, h, L);
  else if (n.includes('three white') || n.includes('three inside up') || n.includes('three outside up')) pThreeCandles(ctx, w, h, true);
  else if (n.includes('three black') || n.includes('three inside down') || n.includes('three outside down')) pThreeCandles(ctx, w, h, false);
  else if (n.includes('abandoned baby'))                          pAbandonedBaby(ctx, w, h, L);
  else if (n.includes('dark cloud'))                              pDarkCloud(ctx, w, h);
  else if (n.includes('double top') || n.includes('double_top') || (n.includes('m') && n.includes('pattern'))) pDoubleTop(ctx, w, h);
  else if (n.includes('double bottom') || n.includes('double_bottom') || (n.includes('w') && n.includes('pattern'))) pDoubleBottom(ctx, w, h);
  else if (n.includes('head') || n.includes('Ã©paule') || n.includes('epaule') || n.includes('ete'))  L ? pInvHnS(ctx, w, h) : pHnS(ctx, w, h);
  else if (n.includes('flag') || n.includes('drapeau') || n.includes('fanion'))  pFlag(ctx, w, h, L);
  else if (n.includes('ascending triangle') || n.includes('triangle ascendant')) pAscTri(ctx, w, h);
  else if (n.includes('descending triangle') || n.includes('triangle descendant')) pDescTri(ctx, w, h);
  else if (n.includes('triangle'))                                pSymTri(ctx, w, h, L);
  else if (n.includes('biseau') || n.includes('wedge'))          pWedge(ctx, w, h, L);
  else if (n.includes('butterfly') || n.includes('papillon'))    pButterfly(ctx, w, h, L);
  else if (n.includes('shark'))                                   pShark(ctx, w, h, L);
  else if (n.includes('compress'))                                pCompression(ctx, w, h, L);
  else                                                            pGeneric(ctx, w, h, direction, name);
}

// â”€â”€ Candlestick patterns â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function pPinBar(ctx, w, h, L) {
  const sy = L ? h*.78 : h*.22;
  ctx.fillStyle = L ? PC.srg : PC.srr; ctx.fillRect(0, sy - 8, w, 16);
  dsr(ctx, sy, w, L ? 'Support' : 'RÃ©sistance', L ? PC.green : PC.red, L);
  if (L) dc(ctx, w*.50, h*.30, h*.26, h*.24, h*.78, PC.green);
  else   dc(ctx, w*.50, h*.60, h*.64, h*.22, h*.68, PC.red);
  darr(ctx, w*.74, L ? h*.44 : h*.62, L ? 'LONG' : 'SHORT');
}

function pHammer(ctx, w, h) {
  ctx.fillStyle = PC.srg; ctx.fillRect(0, h*.70, w, 16);
  dsr(ctx, h*.76, w, 'Support', PC.green, true);
  dc(ctx, w*.50, h*.33, h*.27, h*.25, h*.78, PC.green);
  darr(ctx, w*.74, h*.50, 'LONG');
}

function pShootingStar(ctx, w, h) {
  ctx.fillStyle = PC.srr; ctx.fillRect(0, h*.14, w, 16);
  dsr(ctx, h*.22, w, 'RÃ©sistance', PC.red, false);
  dc(ctx, w*.50, h*.62, h*.68, h*.22, h*.72, PC.red);
  darr(ctx, w*.74, h*.55, 'SHORT');
}

function pEngulfing(ctx, w, h, L) {
  const sy = L ? h*.78 : h*.22;
  ctx.fillStyle = L ? PC.srg : PC.srr; ctx.fillRect(0, sy - 8, w, 16);
  dsr(ctx, sy, w, L ? 'Support' : 'RÃ©sistance', L ? PC.green : PC.red, L);
  if (L) {
    dc(ctx, w*.38, h*.42, h*.52, h*.38, h*.55, PC.red);
    dc(ctx, w*.62, h*.56, h*.30, h*.26, h*.60, PC.green);
  } else {
    dc(ctx, w*.38, h*.55, h*.45, h*.40, h*.58, PC.green);
    dc(ctx, w*.62, h*.35, h*.60, h*.30, h*.64, PC.red);
  }
  darr(ctx, w*.82, h*.50, L ? 'LONG' : 'SHORT');
}

function pDoji(ctx, w, h, L) {
  const sy = L ? h*.78 : h*.22;
  ctx.fillStyle = L ? PC.srg : PC.srr; ctx.fillRect(0, sy - 8, w, 16);
  dsr(ctx, sy, w, L ? 'Support' : 'RÃ©sistance', L ? PC.green : PC.red, L);
  dc(ctx, w*.50, h*.47, h*.49, h*.28, h*.72, PC.gray);
  darr(ctx, w*.74, h*.50, L ? 'LONG' : 'SHORT');
}

function pHarami(ctx, w, h, L) {
  dsr(ctx, L ? h*.78 : h*.22, w, L ? 'Support' : 'RÃ©sistance', L ? PC.green : PC.red, L);
  if (L) {
    dc(ctx, w*.38, h*.35, h*.68, h*.30, h*.72, PC.red);
    dc(ctx, w*.62, h*.50, h*.56, h*.46, h*.60, PC.green);
  } else {
    dc(ctx, w*.38, h*.65, h*.32, h*.28, h*.70, PC.green);
    dc(ctx, w*.62, h*.42, h*.50, h*.38, h*.54, PC.red);
  }
  darr(ctx, w*.82, h*.50, L ? 'LONG' : 'SHORT');
}

function pMorningStar(ctx, w, h) {
  ctx.fillStyle = PC.srg; ctx.fillRect(0, h*.70, w, 16);
  dsr(ctx, h*.76, w, 'Support', PC.green, true);
  dc(ctx, w*.22, h*.30, h*.58, h*.25, h*.62, PC.red);
  dc(ctx, w*.50, h*.65, h*.68, h*.62, h*.72, PC.gray);
  dc(ctx, w*.78, h*.60, h*.34, h*.28, h*.64, PC.green);
  darr(ctx, w*.86, h*.52, 'LONG');
}

function pEveningStar(ctx, w, h) {
  ctx.fillStyle = PC.srr; ctx.fillRect(0, h*.14, w, 16);
  dsr(ctx, h*.22, w, 'RÃ©sistance', PC.red, false);
  dc(ctx, w*.22, h*.68, h*.40, h*.35, h*.72, PC.green);
  dc(ctx, w*.50, h*.32, h*.28, h*.24, h*.36, PC.gray);
  dc(ctx, w*.78, h*.38, h*.65, h*.34, h*.68, PC.red);
  darr(ctx, w*.86, h*.55, 'SHORT');
}

function pThreeCandles(ctx, w, h, bullish) {
  const sy = bullish ? h*.78 : h*.22;
  dsr(ctx, sy, w, bullish ? 'Support' : 'RÃ©sistance', bullish ? PC.green : PC.red, bullish);
  const col = bullish ? PC.green : PC.red;
  if (bullish) {
    dc(ctx, w*.22, h*.65, h*.52, h*.48, h*.68, col);
    dc(ctx, w*.50, h*.52, h*.36, h*.32, h*.55, col);
    dc(ctx, w*.78, h*.38, h*.22, h*.18, h*.42, col);
    darr(ctx, w*.86, h*.35, 'LONG');
  } else {
    dc(ctx, w*.22, h*.35, h*.48, h*.30, h*.52, col);
    dc(ctx, w*.50, h*.48, h*.62, h*.44, h*.66, col);
    dc(ctx, w*.78, h*.60, h*.76, h*.56, h*.80, col);
    darr(ctx, w*.86, h*.68, 'SHORT');
  }
}

function pAbandonedBaby(ctx, w, h, L) {
  dsr(ctx, L ? h*.78 : h*.22, w, L ? 'Support' : 'RÃ©sistance', L ? PC.green : PC.red, L);
  if (L) {
    dc(ctx, w*.22, h*.35, h*.62, h*.30, h*.65, PC.red);
    // gap down doji
    dc(ctx, w*.50, h*.72, h*.74, h*.68, h*.80, PC.gray);
    // gap up green
    dc(ctx, w*.78, h*.60, h*.35, h*.30, h*.64, PC.green);
    darr(ctx, w*.86, h*.48, 'LONG');
  } else {
    dc(ctx, w*.22, h*.65, h*.38, h*.32, h*.68, PC.green);
    dc(ctx, w*.50, h*.28, h*.26, h*.20, h*.32, PC.gray);
    dc(ctx, w*.78, h*.40, h*.65, h*.36, h*.68, PC.red);
    darr(ctx, w*.86, h*.55, 'SHORT');
  }
}

function pDarkCloud(ctx, w, h) {
  ctx.fillStyle = PC.srr; ctx.fillRect(0, h*.14, w, 16);
  dsr(ctx, h*.22, w, 'RÃ©sistance', PC.red, false);
  dc(ctx, w*.38, h*.62, h*.35, h*.30, h*.65, PC.green);
  dc(ctx, w*.62, h*.32, h*.55, h*.28, h*.58, PC.red);
  darr(ctx, w*.82, h*.55, 'SHORT');
}

// â”€â”€ Chart patterns â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function pDoubleTop(ctx, w, h) {
  dsr(ctx, h*.28, w, 'RÃ©sistance', PC.red, false);
  dsr(ctx, h*.72, w, 'Neckline', PC.warn, true);
  const pts = [[0,h*.82],[w*.12,h*.76],[w*.26,h*.28],[w*.38,h*.52],[w*.50,h*.28],[w*.62,h*.50],[w*.72,h*.72],[w*.86,h*.88]];
  dline(ctx, pts, PC.muted);
  ctx.fillStyle = PC.red; ctx.font = 'bold 13px sans-serif'; ctx.textAlign = 'center';
  ctx.fillText('M', w*.38, h*.20); ctx.textAlign = 'left';
  darr(ctx, w*.87, h*.72, 'SHORT');
}

function pDoubleBottom(ctx, w, h) {
  dsr(ctx, h*.72, w, 'Support', PC.green, true);
  dsr(ctx, h*.28, w, 'Neckline', PC.warn, false);
  const pts = [[0,h*.18],[w*.12,h*.24],[w*.26,h*.72],[w*.38,h*.48],[w*.50,h*.72],[w*.62,h*.50],[w*.72,h*.28],[w*.86,h*.12]];
  dline(ctx, pts, PC.muted);
  ctx.fillStyle = PC.green; ctx.font = 'bold 13px sans-serif'; ctx.textAlign = 'center';
  ctx.fillText('W', w*.38, h*.88); ctx.textAlign = 'left';
  darr(ctx, w*.87, h*.30, 'LONG');
}

function pHnS(ctx, w, h) {
  dsr(ctx, h*.68, w, 'Neckline', PC.warn, true);
  const pts = [[0,h*.80],[w*.12,h*.68],[w*.22,h*.42],[w*.30,h*.68],[w*.40,h*.68],[w*.50,h*.18],[w*.60,h*.68],[w*.70,h*.68],[w*.80,h*.42],[w*.88,h*.68],[w,h*.82]];
  dline(ctx, pts, PC.muted);
  ctx.fillStyle = PC.muted; ctx.font = '8px sans-serif'; ctx.textAlign = 'center';
  ctx.fillText('G', w*.22, h*.37); ctx.fillText('T', w*.50, h*.13); ctx.fillText('D', w*.80, h*.37);
  darr(ctx, w*.90, h*.72, 'SHORT'); ctx.textAlign = 'left';
}

function pInvHnS(ctx, w, h) {
  dsr(ctx, h*.32, w, 'Neckline', PC.warn, false);
  const pts = [[0,h*.20],[w*.12,h*.32],[w*.22,h*.58],[w*.30,h*.32],[w*.40,h*.32],[w*.50,h*.82],[w*.60,h*.32],[w*.70,h*.32],[w*.80,h*.58],[w*.88,h*.32],[w,h*.18]];
  dline(ctx, pts, PC.muted);
  ctx.fillStyle = PC.muted; ctx.font = '8px sans-serif'; ctx.textAlign = 'center';
  ctx.fillText('G', w*.22, h*.65); ctx.fillText('T', w*.50, h*.88); ctx.fillText('D', w*.80, h*.65);
  darr(ctx, w*.90, h*.28, 'LONG'); ctx.textAlign = 'left';
}

function pFlag(ctx, w, h, L) {
  if (L) {
    dline(ctx, [[w*.08,h*.80],[w*.35,h*.20]], PC.green, 2.5);
    dline(ctx, [[w*.35,h*.20],[w*.45,h*.30],[w*.56,h*.25],[w*.66,h*.35]], PC.gray);
    dline(ctx, [[w*.35,h*.32],[w*.45,h*.42],[w*.56,h*.37],[w*.66,h*.47]], PC.gray);
    dline(ctx, [[w*.66,h*.35],[w*.90,h*.12]], PC.green, 2);
    darr(ctx, w*.82, h*.22, 'LONG');
  } else {
    dline(ctx, [[w*.08,h*.20],[w*.35,h*.80]], PC.red, 2.5);
    dline(ctx, [[w*.35,h*.80],[w*.45,h*.70],[w*.56,h*.75],[w*.66,h*.65]], PC.gray);
    dline(ctx, [[w*.35,h*.68],[w*.45,h*.58],[w*.56,h*.63],[w*.66,h*.53]], PC.gray);
    dline(ctx, [[w*.66,h*.65],[w*.90,h*.88]], PC.red, 2);
    darr(ctx, w*.82, h*.75, 'SHORT');
  }
}

function pAscTri(ctx, w, h) {
  dsr(ctx, h*.25, w, 'RÃ©sistance', PC.red, false);
  dline(ctx, [[w*.05,h*.75],[w*.78,h*.25]], PC.muted);
  dline(ctx, [[w*.78,h*.25],[w*.95,h*.10]], PC.green, 2);
  darr(ctx, w*.84, h*.20, 'LONG');
}

function pDescTri(ctx, w, h) {
  dsr(ctx, h*.75, w, 'Support', PC.green, true);
  dline(ctx, [[w*.05,h*.25],[w*.78,h*.75]], PC.muted);
  dline(ctx, [[w*.78,h*.75],[w*.95,h*.90]], PC.red, 2);
  darr(ctx, w*.84, h*.78, 'SHORT');
}

function pSymTri(ctx, w, h, L) {
  dline(ctx, [[w*.05,h*.20],[w*.70,h*.45]], PC.muted);
  dline(ctx, [[w*.05,h*.80],[w*.70,h*.55]], PC.muted);
  const col = L ? PC.green : PC.red;
  dline(ctx, [[w*.70,h*.50],[w*.93, L ? h*.25 : h*.75]], col, 2);
  darr(ctx, w*.83, L ? h*.35 : h*.65, L ? 'LONG' : 'SHORT');
}

function pWedge(ctx, w, h, L) {
  if (!L) { // Falling wedge = bullish
    dline(ctx, [[w*.05,h*.20],[w*.72,h*.42]], PC.muted);
    dline(ctx, [[w*.05,h*.40],[w*.72,h*.55]], PC.muted);
    dline(ctx, [[w*.72,h*.48],[w*.92,h*.25]], PC.green, 2);
    darr(ctx, w*.83, h*.35, 'LONG');
  } else { // Rising wedge = bearish
    dline(ctx, [[w*.05,h*.60],[w*.72,h*.42]], PC.muted);
    dline(ctx, [[w*.05,h*.80],[w*.72,h*.58]], PC.muted);
    dline(ctx, [[w*.72,h*.50],[w*.92,h*.75]], PC.red, 2);
    darr(ctx, w*.83, h*.68, 'SHORT');
  }
}

function pButterfly(ctx, w, h, L) {
  ctx.strokeStyle = '#9b7ef5'; ctx.lineWidth = 1.5; ctx.setLineDash([]);
  const P = L
    ? { X:[w*.05,h*.32], A:[w*.25,h*.74], B:[w*.45,h*.44], C:[w*.62,h*.66], D:[w*.82,h*.24] }
    : { X:[w*.05,h*.68], A:[w*.25,h*.26], B:[w*.45,h*.56], C:[w*.62,h*.34], D:[w*.82,h*.76] };
  ctx.beginPath(); ctx.moveTo(...P.X);
  ['A','B','C','D'].forEach(k => ctx.lineTo(...P[k]));
  ctx.stroke();
  ctx.fillStyle = '#9b7ef5'; ctx.font = 'bold 9px sans-serif'; ctx.textAlign = 'center';
  Object.entries(P).forEach(([k, p]) => ctx.fillText(k, p[0], p[1] + (L ? 11 : -4)));
  darr(ctx, P.D[0]+6, P.D[1]+(L?-6:6), L?'LONG':'SHORT'); ctx.textAlign='left';
}

function pShark(ctx, w, h, L) {
  ctx.strokeStyle = '#9b7ef5'; ctx.lineWidth = 1.5; ctx.setLineDash([]);
  const P = L
    ? { O:[w*.05,h*.45], X:[w*.20,h*.75], A:[w*.38,h*.28], B:[w*.55,h*.70], C:[w*.78,h*.18] }
    : { O:[w*.05,h*.55], X:[w*.20,h*.25], A:[w*.38,h*.72], B:[w*.55,h*.30], C:[w*.78,h*.82] };
  ctx.beginPath(); ctx.moveTo(...P.O);
  ['X','A','B','C'].forEach(k => ctx.lineTo(...P[k]));
  ctx.stroke();
  ctx.fillStyle = '#9b7ef5'; ctx.font = 'bold 9px sans-serif'; ctx.textAlign = 'center';
  Object.entries(P).forEach(([k, p]) => ctx.fillText(k, p[0], p[1] + (L ? 11 : -4)));
  darr(ctx, P.C[0]+6, P.C[1]+(L?-6:6), L?'LONG':'SHORT'); ctx.textAlign='left';
}

function pCompression(ctx, w, h, L) {
  ctx.fillStyle = 'rgba(245,166,35,0.07)';
  ctx.fillRect(w*.08, h*.35, w*.58, h*.30);
  ctx.strokeStyle = PC.warn; ctx.lineWidth = 1; ctx.setLineDash([3,3]);
  ctx.strokeRect(w*.08, h*.35, w*.58, h*.30); ctx.setLineDash([]);
  ctx.fillStyle = PC.warn; ctx.font = '8px sans-serif'; ctx.textAlign = 'center';
  ctx.fillText('COMPRESSION', w*.37, h*.52); ctx.textAlign = 'left';
  const col = L ? PC.green : PC.red;
  dline(ctx, [[w*.66,h*.50],[w*.92, L?h*.22:h*.78]], col, 2.5);
  darr(ctx, w*.83, L?h*.35:h*.65, L?'LONG':'SHORT');
}

function pGeneric(ctx, w, h, dir, name) {
  ctx.fillStyle = '#3a3a3a'; ctx.font = '10px sans-serif'; ctx.textAlign = 'center';
  ctx.fillText((name||'').substring(0,22), w/2, h*.42);
  ctx.fillStyle = dir==='LONG' ? PC.green : dir==='SHORT' ? PC.red : PC.gray;
  ctx.font = 'bold 26px sans-serif';
  ctx.fillText(dir==='LONG'?'â†‘':dir==='SHORT'?'â†“':'â€”', w/2, h*.72);
  ctx.textAlign = 'left';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATA & RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let allAnalyses = [];
let fDir = 'ALL', fTf = 'ALL';

function scoreColor(s) {
  return s >= 7 ? '#2dcc74' : s >= 5 ? '#f5a623' : '#e84545';
}

function fmt(v, d) {
  if (!v || v === 0) return 'â€”';
  return parseFloat(v).toFixed(d !== undefined ? d : 4);
}

function cardHtml(a, idx) {
  const dir  = (a.direction || 'NEUTRAL').toUpperCase();
  const dc   = dir === 'LONG' ? 'long' : dir === 'SHORT' ? 'short' : 'wait';
  const vt   = dir === 'LONG' ? 'BUY' : dir === 'SHORT' ? 'SELL' : 'WAIT';
  const sc   = a.confluence_score || 0;
  const scC  = scoreColor(sc);
  const pair = a.pair || 'â€”';
  const tf   = a.timeframe || 'â€”';
  const patt = a.pattern || 'Analyse';
  const tmpl = a.template || '';
  const ts   = (a.timestamp || '').substring(0, 16);

  // Image path: could be full path or just filename
  const imgRaw = a.image_path || '';
  const imgFn  = imgRaw ? imgRaw.split('/').pop().split('\\').pop() : '';
  const thumbHtml = imgFn
    ? `<img class="thumb" src="/screenshots/${imgFn}" alt="chart"
         onclick="openLb('/screenshots/${imgFn}')"
         onerror="this.style.display='none'">`
    : '';

  // Gates
  const g1 = a.gate1_sr;
  const g2 = a.gate2_pattern;
  const g1ok = g1 && g1 !== '' && g1 !== false;
  const g2ok = g2 && g2 !== '' && g2 !== false;

  // Tags
  let tags = `<span class="tag trr">RR 1:${fmt(a.rr_ratio, 1)}</span>`;
  if (a.adx && a.adx >= 20) tags += `<span class="tag tadx">ADX ${Math.round(a.adx)}</span>`;
  if (a.rsi && a.rsi > 0)   tags += `<span class="tag trsi">RSI ${Math.round(a.rsi)}</span>`;
  if (a.qqe && a.qqe.includes('crois')) tags += `<span class="tag tqqe">QQE âœ“</span>`;
  if (a.compression)  tags += `<span class="tag tcomp">Compression ğŸ”¥</span>`;
  if (a.harmonics && a.harmonics.length > 2) tags += `<span class="tag thtf">Harmonique</span>`;
  if (a.ema && a.ema.length > 2) tags += `<span class="tag thtf">${a.ema.substring(0,30)}</span>`;
  if (a.warnings && a.warnings.length)
    a.warnings.slice(0,2).forEach(w => tags += `<span class="tag twarn">âš  ${w.substring(0,28)}</span>`);

  const sumHtml = a.summary
    ? `<div class="summary">${a.summary.substring(0,220)}${a.summary.length>220?'â€¦':''}</div>`
    : '';

  return `
<div class="acard ${dc}" data-dir="${dir}" data-tf="${tf.toUpperCase().replace('1H','H1').replace('4H','H4')}">
  <div class="acard-top">
    <div class="verdict ${dc}">${vt}</div>
    <div class="vmeta">
      <div class="vpair">${pair}</div>
      <div class="vtf">${tf}${tmpl?' Â· '+tmpl:''} ${ts?'Â· '+ts:''}</div>
      <div class="vpatt">${patt}</div>
    </div>
  </div>

  <div class="score-wrap">
    <div class="score-hd">
      <span>Confluence</span>
      <span style="color:${scC}">${sc} / 10</span>
    </div>
    <div class="score-bar">
      <div class="score-fill" style="width:${sc*10}%;background:${scC}"></div>
    </div>
  </div>

  <div class="patt-wrap">
    <canvas class="patt-canvas" id="pc${idx}" width="640" height="160"></canvas>
    <div class="patt-lbl">${patt}</div>
  </div>

  ${thumbHtml}

  <div class="price-grid">
    <div class="pbox entry"><div class="pl">EntrÃ©e</div><div class="pv">${fmt(a.entry)}</div></div>
    <div class="pbox sl"><div class="pl">Stop</div><div class="pv">${fmt(a.sl)}</div></div>
    <div class="pbox tp1"><div class="pl">TP1</div><div class="pv">${fmt(a.tp1)}</div></div>
    <div class="pbox tp2"><div class="pl">TP2</div><div class="pv">${fmt(a.tp2)}</div></div>
  </div>

  <div class="gates">
    <span class="gate ${g1ok?'ok':'fail'}">${g1ok?'âœ“':'âœ—'} Porte 1 S/R</span>
    <span class="gate ${g2ok?'ok':'fail'}">${g2ok?'âœ“':'âœ—'} Porte 2 Figure</span>
  </div>

  <div class="tags">${tags}</div>

  ${sumHtml}
</div>`;
}

function renderAnalyses() {
  const grid = document.getElementById('analyses-grid');
  let list = allAnalyses.filter(a => {
    const d = (a.direction||'NEUTRAL').toUpperCase();
    if (fDir !== 'ALL' && d !== fDir) return false;
    const t = (a.timeframe||'').toUpperCase().replace('1H','H1').replace('4H','H4');
    if (fTf !== 'ALL' && t !== fTf) return false;
    return true;
  });

  if (!list.length) {
    grid.innerHTML = `<div class="empty">
      <div class="ico">ğŸ“Š</div>
      <h3>Aucune analyse</h3>
      <p>Lance une analyse depuis le terminal Claude Code<br>puis utilise le script <code>save_analysis</code> pour la sauvegarder.</p>
    </div>`;
    return;
  }

  grid.innerHTML = list.map((a, i) => cardHtml(a, i)).join('');

  // Draw patterns on canvases after DOM update
  requestAnimationFrame(() => {
    list.forEach((a, i) => {
      const c = document.getElementById(`pc${i}`);
      if (c) drawPattern(c, a.pattern || '', a.direction || 'NEUTRAL');
    });
  });
}

function updateStats() {
  const t = allAnalyses.length;
  const l = allAnalyses.filter(a => a.direction === 'LONG').length;
  const s = allAnalyses.filter(a => a.direction === 'SHORT').length;
  const scores = allAnalyses.map(a => a.confluence_score||0).filter(x => x > 0);
  const avg = scores.length ? (scores.reduce((a,b)=>a+b,0)/scores.length).toFixed(1) : 'â€”';
  document.getElementById('st-total').textContent = t;
  document.getElementById('st-long').textContent  = l;
  document.getElementById('st-short').textContent = s;
  document.getElementById('st-score').textContent = avg;
  const tc = document.getElementById('tc-analyses');
  tc.textContent = t;
  tc.className = 'tab-count' + (t > 0 ? ' has' : '');
}

async function loadAnalyses() {
  const badge = document.getElementById('refresh-badge');
  badge.textContent = 'Chargementâ€¦'; badge.className = 'refresh-badge active';
  try {
    const res  = await fetch('/api/analyses');
    const data = await res.json();
    allAnalyses = Array.isArray(data) ? data : (data.analyses || []);
    renderAnalyses();
    updateStats();
    badge.textContent = 'Mis Ã  jour'; badge.className = 'refresh-badge';
  } catch(e) {
    badge.textContent = 'Erreur'; badge.className = 'refresh-badge';
  }
}

// Filters
document.querySelectorAll('#fdir .fbtn').forEach(b => b.addEventListener('click', () => {
  document.querySelectorAll('#fdir .fbtn').forEach(x => x.classList.remove('active'));
  b.classList.add('active'); fDir = b.dataset.dir; renderAnalyses();
}));
document.querySelectorAll('#ftf .fbtn').forEach(b => b.addEventListener('click', () => {
  document.querySelectorAll('#ftf .fbtn').forEach(x => x.classList.remove('active'));
  b.classList.add('active'); fTf = b.dataset.tf; renderAnalyses();
}));

// Tabs
document.querySelectorAll('.tab-btn').forEach(b => b.addEventListener('click', () => {
  document.querySelectorAll('.tab-btn').forEach(x => x.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(x => x.classList.remove('active'));
  b.classList.add('active');
  document.getElementById('panel-' + b.dataset.tab).classList.add('active');
  if (b.dataset.tab === 'analyses') loadAnalyses();
}));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UPLOAD MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let selFile = null;

function openModal()  { document.getElementById('modal').classList.add('open'); }
function closeModal() { document.getElementById('modal').classList.remove('open'); selFile = null; }

function onFileSelect(inp) {
  if (inp.files[0]) {
    selFile = inp.files[0];
    const pv = document.getElementById('drop-preview');
    pv.textContent = 'âœ“ ' + selFile.name; pv.style.display = 'block';
  }
}

const dz = document.getElementById('drop-zone');
dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('over'); });
dz.addEventListener('dragleave', () => dz.classList.remove('over'));
dz.addEventListener('drop', e => {
  e.preventDefault(); dz.classList.remove('over');
  if (e.dataTransfer.files[0]) {
    selFile = e.dataTransfer.files[0];
    const pv = document.getElementById('drop-preview');
    pv.textContent = 'âœ“ ' + selFile.name; pv.style.display = 'block';
  }
});

async function submitUpload() {
  if (!selFile) { alert('SÃ©lectionne un screenshot'); return; }
  const btn = document.getElementById('up-btn');
  btn.disabled = true; btn.textContent = 'Envoiâ€¦';
  const fd = new FormData();
  fd.append('file', selFile);
  fd.append('pair', document.getElementById('up-pair').value);
  fd.append('timeframe', document.getElementById('up-tf').value);
  fd.append('template', document.getElementById('up-tmpl').value);
  fd.append('notes', document.getElementById('up-notes').value);
  try {
    await fetch('/api/analyze-image', { method: 'POST', body: fd });
    closeModal();
    await loadAnalyses();
  } catch(e) {}
  btn.disabled = false; btn.textContent = 'Enregistrer le screenshot';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCAN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let evtSrc = null;

function startScan() {
  const pair = document.getElementById('scan-pair').value;
  const tf   = document.getElementById('scan-tf').value;
  const btn  = document.getElementById('scan-btn');
  btn.disabled = true; btn.textContent = 'Scanâ€¦';
  document.getElementById('scan-log').innerHTML = '';
  document.getElementById('scan-sigs').innerHTML = '<div style="color:var(--muted);font-size:11px;text-align:center;padding:20px 0">Scan en coursâ€¦</div>';

  fetch('/api/scan', {
    method: 'POST', headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ pairs: pair?[pair]:[], timeframes: tf?[tf]:[] })
  }).then(r => r.json()).then(d => {
    openSSE(d.scan_id);
  }).catch(() => {
    btn.disabled = false; btn.textContent = 'Lancer le scan';
  });
}

function openSSE(id) {
  if (evtSrc) evtSrc.close();
  const log = document.getElementById('scan-log');
  evtSrc = new EventSource(`/api/stream/${id}`);

  evtSrc.onmessage = e => {
    const msg = e.data;
    if (msg === '__SCAN_DONE__' || msg === '[DONE]') {
      evtSrc.close();
      document.getElementById('scan-btn').disabled = false;
      document.getElementById('scan-btn').textContent = 'Lancer le scan';
      document.getElementById('scan-status').textContent = 'TerminÃ© âœ“';
      fetchScanResults(id);
      return;
    }
    if (msg === '__HEARTBEAT__') return;
    const l = document.createElement('div');
    l.className = 'll';
    const m = msg.toLowerCase();
    if (m.includes('signal') || m.includes('dÃ©tect')) l.classList.add('sig');
    else if (m.includes('erreur') || m.includes('error')) l.classList.add('err');
    else if (m.includes('warning') || m.includes('warn')) l.classList.add('warn');
    l.textContent = msg;
    log.appendChild(l);
    log.scrollTop = log.scrollHeight;
  };

  evtSrc.onerror = () => {
    evtSrc.close();
    fetchScanResults(id);
    document.getElementById('scan-btn').disabled = false;
    document.getElementById('scan-btn').textContent = 'Lancer le scan';
  };
}

async function fetchScanResults(id) {
  try {
    const r = await fetch(`/api/results/${id}`);
    const d = await r.json();
    const sigs = d.signals || [];
    const box  = document.getElementById('scan-sigs');
    if (!sigs.length) {
      box.innerHTML = '<div style="color:var(--muted);font-size:11px;text-align:center;padding:20px 0">Aucun signal</div>';
      return;
    }
    box.innerHTML = sigs.map(s => {
      const dc = s.direction === 'LONG' ? 'long' : 'short';
      const col = s.direction === 'LONG' ? 'var(--long)' : 'var(--short)';
      return `<div class="sig-card ${dc}">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <span class="sig-pair">${s.pair}</span>
          <span class="sig-dir-${dc[0]}">${s.direction}</span>
        </div>
        <div class="sig-info">${s.pattern||''} Â· ${s.timeframe||''}</div>
        <div class="sig-prices">
          <div class="sp"><span>ENTRY</span> <b style="color:var(--accent)">${fmt(s.entry)}</b></div>
          <div class="sp"><span>SL</span> <b style="color:var(--short)">${fmt(s.sl)}</b></div>
          <div class="sp"><span>TP1</span> <b style="color:var(--warn)">${fmt(s.tp1)}</b></div>
          <div class="sp"><span>TP2</span> <b style="color:var(--long)">${fmt(s.tp2)}</b></div>
        </div>
      </div>`;
    }).join('');
  } catch(e) {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LIGHTBOX
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function openLb(src) {
  document.getElementById('lb-img').src = src;
  document.getElementById('lightbox').classList.add('open');
}
function closeLightbox() {
  document.getElementById('lightbox').classList.remove('open');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

window.addEventListener('DOMContentLoaded', () => {
  loadAnalyses();
  setInterval(loadAnalyses, 30000); // refresh toutes les 30s
});
</script>
</body>
</html>
